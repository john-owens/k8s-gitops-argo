alertmanager.yaml: |-
  global:
    resolve_timeout: 5m
    slack_api_url: $DISCORD_ALERTMANAGER_WEBHOOK_URL
  receivers:
  - name: 'null'
  - name: 'slack-notifications'
    slack_configs:
      - channel: '#notifications'
        icon_url: https://avatars3.githubusercontent.com/u/3380462
        username: 'Alertmanager'
        send_resolved: true
        title: |-
          [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ if ne .CommonAnnotations.summary ""}}{{ .CommonAnnotations.summary }} {{ else if ne .CommonAnnotations.message ""}}{{ .CommonAnnotations.message }} {{ else if ne .CommonAnnotations.description ""}}{{ .CommonAnnotations.description }} {{ else }}{{ .CommonLabels.alertname }}{{ end }}
        text: >-
          {{ range .Alerts -}}
            *Alert:* {{ .Annotations.title }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}

          {{ if ne .Annotations.summary ""}}*Summary:* {{ .Annotations.summary }} {{ else if ne .Annotations.message ""}}*Message:* {{ .Annotations.message }} {{ else if ne .Annotations.description ""}}*Description:* {{ .Annotations.description }}{{ end }}

          *Details:*
            {{ range .Labels.SortedPairs }} â€¢ *{{ .Name }}:* `{{ .Value }}`
            {{ end }}
          {{ end }}
  - name: 'pagerduty'
    pagerduty_configs:
      - routing_key: $PD_TOKEN
        description: |-
          {{ template "pagerduty.custom.description" . }}
  route:
    # group_by: ['alertname', 'job']
    # group_wait: 30s
    # group_interval: 5m
    # repeat_interval: 6h
    receiver: 'slack-notifications'
    # receiver: 'pagerduty'
    routes:
      - match:
          alertname: Watchdog
        receiver: 'null'
      - receiver: 'pagerduty'
        match:
          severity: critical
        continue: true
      - receiver: 'slack-notifications'
  inhibit_rules:
  - equal:
    - alertname
    - namespace
    source_match:
      severity: critical
    target_match:
      severity: warning
  receivers:
  - name: "null"
  templates:
  - '*.tmpl'

pagerduty-custom.tmpl: '{{- define "pagerduty.custom.description" -}}[{{ .Status |
  toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ if
  ne .CommonAnnotations.summary ""}}{{ .CommonAnnotations.summary }} {{ else if ne
  .CommonAnnotations.message ""}}{{ .CommonAnnotations.message }} {{ else if ne .CommonAnnotations.description
  ""}}{{ .CommonAnnotations.description }} {{ else }}{{ .CommonLabels.alertname }}{{
  end }}{{- end -}}'
